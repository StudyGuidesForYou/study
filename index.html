<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ultimate Ball Simulator</title>
<style>
body { margin:0; background:black; overflow:hidden; font-family:Arial,sans-serif; color:white;}
#ui {position:fixed; top:10px; right:10px; background:rgba(20,20,20,0.85); padding:15px; border-radius:12px; backdrop-filter:blur(10px); z-index:10;}
button, select, input {width:150px; margin:5px 0; padding:6px; font-size:14px; border-radius:8px; border:none; background:#222; color:white; cursor:pointer;}
#combineModes {margin-top:10px; display:flex; flex-direction:column;}
label {font-size:14px; margin:2px 0; cursor:pointer;}
#speedLabel {margin-top:10px;}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="ui">
  <button id="addBallBtn">Add Ball</button>
  <button id="removeBallBtn">Remove Ball</button>
  <button id="toggleCamBtn">Toggle Cam Follow</button>
  <select id="mode">
    <option value="none">Low Quality</option>
    <option value="gravity">Gravity</option>
    <option value="blackhole">Gravity Ball</option>
    <option value="double">Double Trouble</option>
  </select>
  <div id="combineModes">
    <label><input type="checkbox" value="gravity"> Gravity</label>
    <label><input type="checkbox" value="blackhole"> Gravity Ball</label>
    <label><input type="checkbox" value="double"> Double Trouble</label>
  </div>
  <label id="speedLabel">Ball Speed: <span id="speedVal">1</span></label>
  <input type="range" id="speedSlider" min="0.2" max="3" step="0.05" value="1">
</div>
<script>
const canvas=document.getElementById("c"), ctx=canvas.getContext("2d");
let w,h,cx,cy,radius;
function resize(){ w=canvas.width=window.innerWidth; h=canvas.height=window.innerHeight; cx=w/2; cy=h/2; radius=Math.min(w,h)*0.4; }
window.onresize=resize; resize();

const MAX_BALLS=100;
let ballSpeed=1;

// Particles for black hole
class Particle{
  constructor(x,y){ this.x=x; this.y=y; this.vx=(Math.random()-0.5)*2; this.vy=(Math.random()-0.5)*2; this.life=Math.random()*50+50; this.size=Math.random()*3+2; }
  update(){ this.x+=this.vx; this.y+=this.vy; this.life--; this.size*=0.96; }
  draw(){ ctx.beginPath(); ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fillStyle=`rgba(0,255,255,${Math.max(this.life/50,0)})`; ctx.fill(); }
}

// Ball class
class Ball{
  constructor(){ this.reset(); }
  reset(){ this.x=cx+(Math.random()*2-1)*50; this.y=cy+(Math.random()*2-1)*50; const a=Math.random()*Math.PI*2; const s=3+Math.random()*2; this.vx=Math.cos(a)*s; this.vy=Math.sin(a)*s; this.trail=[]; }
  update(){
    const modes=getActiveModes();
    // Apply gravity
    if(modes.includes("gravity")) this.vy+=0.3*ballSpeed;
    // Apply black hole pull
    if(modes.includes("blackhole")){
      const dx=blackhole.x-this.x, dy=blackhole.y-this.y;
      const dist=Math.sqrt(dx*dx+dy*dy);
      const g=Math.min(50,2000/(dist*dist+50));
      this.vx+=dx/dist*g*ballSpeed; this.vy+=dy/dist*g*ballSpeed;
    }
    // Velocity damping
    this.vx*=0.995; this.vy*=0.995;
    // Update position
    this.x+=this.vx; this.y+=this.vy;

    // Circle boundary collision
    const dx=this.x-cx, dy=this.y-cy, dist=Math.sqrt(dx*dx+dy*dy);
    if(dist>radius){
      const nx=dx/dist, ny=dy/dist, dot=this.vx*nx+this.vy*ny;
      this.vx-=2*dot*nx; this.vy-=2*dot*ny;
      this.vx*=0.9; this.vy*=0.9;
      // Double Trouble safe spawn
      if(getActiveModes().includes("double")){
        const current=balls.length;
        for(let i=0;i<current;i++) if(balls.length<MAX_BALLS) spawnBall();
      }
    }
    this.trail.push({x:this.x,y:this.y,v:Math.sqrt(this.vx*this.vx+this.vy*this.vy)});
    if(this.trail.length>50) this.trail.shift();
  }
  draw(){
    for(let i=0;i<this.trail.length;i++){
      const p=this.trail[i]; ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2);
      let alpha=Math.min(p.v/10,1);
      ctx.fillStyle=`hsla(${i*5},100%,50%,${alpha*0.4})`; ctx.fill();
    }
    ctx.beginPath(); ctx.arc(this.x,this.y,10,0,Math.PI*2);
    ctx.fillStyle="lime"; ctx.shadowColor="lime"; ctx.shadowBlur=10; ctx.fill(); ctx.shadowBlur=0;
  }
}

let balls=[new Ball()], particles=[];
function spawnBall(){ balls.push(new Ball()); }

let camFollow=false, modeSel=document.getElementById("mode");
const combineCheckboxes=document.querySelectorAll("#combineModes input");
const blackhole={angle:0,x:0,y:0};

// Mode reset & checkbox logic
modeSel.onchange=()=>{ balls=[new Ball()]; updateCheckboxesFromSelect(); }
combineCheckboxes.forEach(cb=>{
  cb.addEventListener("change",()=>{
    // Mutual exclusion: gravity vs blackhole
    if(cb.value==="gravity" && cb.checked) document.querySelector('input[value="blackhole"]').checked=false;
    if(cb.value==="blackhole" && cb.checked) document.querySelector('input[value="gravity"]').checked=false;
    modeSel.value=cb.checked?cb.value:"none"; balls=[new Ball()];
  });
});
function getActiveModes(){ return Array.from(combineCheckboxes).filter(cb=>cb.checked).map(cb=>cb.value); }
function updateCheckboxesFromSelect(){ combineCheckboxes.forEach(cb=>{cb.checked=cb.value===modeSel.value;}); }

// Speed slider
const speedSlider=document.getElementById("speedSlider"), speedVal=document.getElementById("speedVal");
speedSlider.oninput=()=>{ ballSpeed=parseFloat(speedSlider.value); speedVal.textContent=ballSpeed.toFixed(2); }

// Loop
function loop(){
  requestAnimationFrame(loop);
  ctx.clearRect(0,0,w,h);
  const modes=getActiveModes();

  // Black hole orbit & particles
  if(modes.includes("blackhole")){
    blackhole.angle+=0.01;
    blackhole.x=cx+Math.cos(blackhole.angle)*(radius+50);
    blackhole.y=cy+Math.sin(blackhole.angle)*(radius+50);
    for(let i=0;i<3;i++) particles.push(new Particle(blackhole.x,blackhole.y));
    let grad=ctx.createRadialGradient(blackhole.x,blackhole.y,5,blackhole.x,blackhole.y,35);
    grad.addColorStop(0,"black"); grad.addColorStop(0.5,"purple"); grad.addColorStop(1,"rgba(0,0,0,0)");
    ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(blackhole.x,blackhole.y,20,0,Math.PI*2); ctx.fill();
  }

  // Update particles
  particles.forEach(p=>p.update()); particles=particles.filter(p=>p.life>0); particles.forEach(p=>p.draw());

  // Camera follow center of mass
  let camX=0, camY=0;
  if(camFollow && balls.length>0){
    let avgX=0, avgY=0; balls.forEach(b=>{avgX+=b.x; avgY+=b.y;}); avgX/=balls.length; avgY/=balls.length;
    camX+=(cx-avgX-camX)*0.05; camY+=(cy-avgY-camY)*0.05;
  }
  ctx.save(); ctx.translate(camX,camY);

  // Outer circle glow
  ctx.beginPath(); ctx.arc(cx,cy,radius,0,Math.PI*2);
  ctx.strokeStyle="rgba(0,255,0,0.5)"; ctx.lineWidth=5; ctx.shadowBlur=20; ctx.shadowColor="lime"; ctx.stroke(); ctx.shadowBlur=0;

  // Balls
  balls.forEach(b=>b.update()); balls.forEach(b=>b.draw());

  ctx.restore();
}
requestAnimationFrame(loop);

// UI buttons
document.getElementById("addBallBtn").onclick=()=>{ if(balls.length<MAX_BALLS) spawnBall(); };
document.getElementById("removeBallBtn").onclick=()=>{ if(balls.length>1) balls.pop(); };
document.getElementById("toggleCamBtn").onclick=()=>camFollow=!camFollow;
</script>
</body>
</html>
