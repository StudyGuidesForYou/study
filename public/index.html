<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Game Dashboard</title>
<style>
  * { box-sizing: border-box; margin:0; padding:0;}
  body { font-family: "Roboto", sans-serif; background:#0f1116; color:#fff; }
  .top-bar { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:#181a21; border-bottom:1px solid #252933;}
  .username-display { font-weight:600; }
  button { padding:6px 12px; background:#3a7afe; border:none; border-radius:8px; color:white; cursor:pointer; margin-left:5px; }
  button:hover { background:#2f4ac7; }
  #settingsPanel { position:absolute; top:50px; right:20px; background:#181a21; border:1px solid #252933; border-radius:10px; padding:10px; display:none; flex-direction:column; }
  #settingsPanel input { margin-bottom:5px; padding:6px; border-radius:6px; border:none; width:160px; }
  #gamesScreen { padding:80px 30px 30px 30px; display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:25px; }
  .game-card { background:#181b22; border:1px solid #252933; border-radius:12px; padding:15px; text-align:center; cursor:pointer; transition:all 0.25s ease; }
  .game-card img { width:100%; height:110px; object-fit:cover; border-radius:10px; margin-bottom:10px; }
  #gameModal { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(0); background:#101217; border-radius:15px; width:94vw; height:88vh; z-index:1000; display:flex; flex-direction:column; transition: transform 0.3s ease; overflow:hidden; }
  #gameModal.active { transform:translate(-50%,-50%) scale(1); }
  #gameFrame { flex:1; width:100%; height:100%; border:none; background:#000; }
  .game-controls { display:flex; justify-content:space-between; padding:10px; background:#181b22; border-top:1px solid #252933; }
  #chatModal { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(0); background:#181a21; width:400px; height:500px; z-index:1100; border-radius:12px; display:flex; flex-direction:column; transition:transform 0.3s ease; overflow:hidden; }
  #chatModal.active { transform:translate(-50%,-50%) scale(1); }
  #chatMessages { flex:1; overflow-y:auto; padding:10px; }
  #chatInput { display:flex; padding:10px; border-top:1px solid #252933; }
  #chatInput input { flex:1; padding:6px; border-radius:6px; border:none; margin-right:5px; }
  #overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; z-index:900; }
  #overlay.active { display:block; }
</style>
</head>
<body>

<div class="top-bar">
  <div>Game Dashboard</div>
  <div>
    <span class="username-display" id="usernameDisplay"></span>
    <button id="settingsBtn">⚙️</button>
  </div>
</div>

<div id="settingsPanel">
  <input type="text" placeholder="Username" id="signupUsername">
  <input type="password" placeholder="Password" id="signupPassword">
  <button id="signupBtn">Sign Up</button>
  <button id="loginBtn">Log In</button>
  <button id="chatBtn">Chat</button>
</div>

<div id="gamesScreen">
  <div class="game-card" data-url="https://play2048.co/"><img src="https://upload.wikimedia.org/wikipedia/commons/0/09/2048_logo.png"><p>2048</p></div>
  <div class="game-card" data-url="https://slowroads.io/"><img src="https://i.imgur.com/3df4LxE.png"><p>Slow Roads</p></div>
  <div class="game-card" data-url="https://bloxd.io/"><img src="https://i.imgur.com/IXq3V2y.png"><p>Bloxd.io</p></div>
</div>

<div id="gameModal">
  <iframe id="gameFrame"></iframe>
  <div class="game-controls">
    <button id="fullscreenBtn">⛶ Fullscreen</button>
    <button id="closeBtn">✕ Close</button>
  </div>
</div>

<div id="chatModal">
  <div id="chatMessages"></div>
  <div id="chatInput">
    <input type="text" id="chatText" placeholder="Type a message...">
    <button id="sendChatBtn">Send</button>
  </div>
</div>

<div id="overlay"></div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
let token = localStorage.getItem('token') || null;
let currentUser = null;
const usernameDisplay = document.getElementById('usernameDisplay');
const settingsBtn = document.getElementById('settingsBtn');
const settingsPanel = document.getElementById('settingsPanel');
const signupBtn = document.getElementById('signupBtn');
const loginBtn = document.getElementById('loginBtn');
const chatBtn = document.getElementById('chatBtn');
const signupUsername = document.getElementById('signupUsername');
const signupPassword = document.getElementById('signupPassword');
const chatModal = document.getElementById('chatModal');
const chatMessages = document.getElementById('chatMessages');
const chatText = document.getElementById('chatText');
const sendChatBtn = document.getElementById('sendChatBtn');
const overlay = document.getElementById('overlay');

function setUser(user, tokenStr){
  currentUser = user;
  token = tokenStr;
  localStorage.setItem('token', tokenStr);
  usernameDisplay.textContent = user.username;
}

async function apiPost(path, data){
  const res = await fetch(path, {
    method:'POST',
    headers:{'Content-Type':'application/json', 'Authorization': token ? 'Bearer '+token : ''},
    body:JSON.stringify(data)
  });
  return res.json();
}

async function apiGet(path){
  const res = await fetch(path, { headers:{ 'Authorization': token ? 'Bearer '+token : '' } });
  return res.json();
}

signupBtn.onclick = async ()=>{
  const res = await apiPost('/api/signup',{username:signupUsername.value,password:signupPassword.value});
  if(res.error) return alert(res.error);
  setUser(res.user,res.token);
  settingsPanel.style.display='none';
}

loginBtn.onclick = async ()=>{
  const res = await apiPost('/api/login',{username:signupUsername.value,password:signupPassword.value});
  if(res.error) return alert(res.error);
  setUser(res.user,res.token);
  settingsPanel.style.display='none';
}

settingsBtn.onclick = ()=>{ settingsPanel.style.display = settingsPanel.style.display==='flex'?'none':'flex'; }
chatBtn.onclick = ()=>{ chatModal.classList.add('active'); overlay.classList.add('active'); }

overlay.onclick = ()=>{
  chatModal.classList.remove('active');
  document.getElementById('gameModal').classList.remove('active');
  overlay.classList.remove('active');
}

sendChatBtn.onclick = ()=>{
  if(!chatText.value.trim()) return;
  socket.emit('chat-message',{text:chatText.value});
  chatText.value='';
}

const socket = io('/', { auth:{token: token} });

socket.on('chat-history', msgs=>{ chatMessages.innerHTML=''; msgs.forEach(m=>addChatMessage(m)); chatMessages.scrollTop=chatMessages.scrollHeight; });
socket.on('chat-message', addChatMessage);

function addChatMessage(msg){
  const el = document.createElement('div');
  el.textContent = msg.username+': '+msg.text;
  chatMessages.appendChild(el);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// --- Games ---
document.querySelectorAll('.game-card').forEach(card=>{
  card.onclick = ()=>{
    document.getElementById('gameFrame').src = card.dataset.url;
    document.getElementById('gameModal').classList.add('active');
    overlay.classList.add('active');
  }
});

document.getElementById('closeBtn').onclick = ()=>{
  document.getElementById('gameModal').classList.remove('active');
  overlay.classList.remove('active');
  document.getElementById('gameFrame').src='';
}

document.getElementById('fullscreenBtn').onclick = ()=>{
  const modal = document.getElementById('gameModal');
  if(!document.fullscreenElement) modal.requestFullscreen();
  else document.exitFullscreen();
}

// --- Load user from token ---
if(token){
  apiGet('/api/me').then(res=>{
    if(!res.error) setUser(res,res.token||token);
  });
}
</script>
</body>
</html>
